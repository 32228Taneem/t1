<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Edit Subtopic</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.tiny.cloud/1/lezf5y9e1y8vwjv3870f06avrgu9855j1octvf69ab6d8hut/tinymce/6/tinymce.min.js"
    referrerpolicy="origin"></script>

  <style>
    :root {
      --primary-blue: #3498db;
      --secondary-green: #2ecc71;
      --dark-navy: #2c3e50;
      --light-gray: #ecf0f1;
      --danger-red: #e74c3c;
      --cloud-white: #f8f9fa;
      --pure-white: #ffffff;
      --nav-bg: #343a40;
      --nav-hover: #495057;
      --shadow-5: rgba(0, 0, 0, 0.05);
      --shadow-10: rgba(0, 0, 0, 0.1);
      --shadow-15: rgba(0, 0, 0, 0.15);
      --shadow-20: rgba(0, 0, 0, 0.2);
      --border-light: #dee2e6;
      --text-muted: #6c757d;
    }

    body {
      min-height: 100vh;
      background: var(--cloud-white);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 2px 6px var(--shadow-10);
      border: none;
    }

    .btn {
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-10);
    }

    /* Custom Alert Styling */
    .custom-alert {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1060;
      min-width: 300px;
      max-width: 400px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow-15);
      font-size: 0.95rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .custom-alert.show {
      opacity: 1;
      transform: translateY(0);
    }

    .custom-alert.alert-success {
      background-color: var(--secondary-green);
      color: var(--pure-white);
      border: 1px solid #28a745;
    }

    .custom-alert.alert-danger {
      background-color: var(--danger-red);
      color: var(--pure-white);
      border: 1px solid #dc3545;
    }

    .custom-alert.alert-info {
      background-color: var(--primary-blue);
      color: var(--pure-white);
      border: 1px solid #007bff;
    }

    .custom-alert .btn-close {
      filter: invert(1);
    }

    /* Custom Modal for Unsaved Changes */
    #unsavedChangesModal .modal-content {
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-20);
    }
    
    #unsavedChangesModal .modal-header {
      background-color: #f8d7da;
      border-bottom: 1px solid #f5c6cb;
    }
    
    #unsavedChangesModal .modal-title {
      color: #721c24;
    }

    /* Custom Modal for Cancel Confirmation */
    #cancelConfirmModal .modal-content {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    #cancelConfirmModal .modal-header {
      background-color: #d1ecf1;
      border-bottom: 1px solid #bee5eb;
    }
    
    #cancelConfirmModal .modal-title {
      color: #0c5460;
    }

    /* Navigation */
    .navbar {
      background-color: var(--nav-bg);
      box-shadow: 0 2px 10px var(--shadow-10);
    }

    .navbar-brand {
      font-weight: 700;
      color: var(--pure-white);
    }

    .nav-link {
      color: var(--pure-white);
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      background-color: var(--nav-hover);
      border-radius: 4px;
    }

    .logout-item .nav-link {
      background-color: var(--danger-red);
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .logout-item .nav-link:hover {
      background-color: var(--danger-red);
      transform: translateY(-2px);
    }
  </style>
</head>

<body>
  {% include 'admin/base.html' %}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="{{ url_for('view_content', item_name=item_name) }}" class="btn btn-secondary" id="backButton">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
      <h3 class="text-primary mb-0">Edit Subtopic</h3>
      <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    </div>

    <div class="card p-4">
      <form method="POST" action="{{ url_for('edit_subtopic', sub_id=sub_id) }}" onsubmit="return saveContent();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label class="form-label">Subtopic Title</label>
          <input type="text" name="title" value="{{ title }}" class="form-control" required id="titleInput">
        </div>

        <div class="mb-3">
          <label class="form-label">Content</label>
          <textarea id="editor" name="content">{{ content|safe }}</textarea>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-2"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Confirmation Modal -->
  <div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-question-circle me-2"></i>Confirm Cancellation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to cancel? Any unsaved changes will be lost.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelNoBtn">No, Continue Editing</button>
          <button type="button" class="btn btn-primary" id="cancelYesBtn">Yes, Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Unsaved Changes Modal -->
  <div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Unsaved Changes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You have unsaved changes. If you leave now, your changes will be lost.</p>
          <p>Are you sure you want to leave?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="stayOnPageBtn">Stay on Page</button>
          <button type="button" class="btn btn-danger" id="confirmLeaveBtn">Leave Without Saving</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Use the exact same configuration as your main form
  const tinyMCEConfig = {
    height: 400,
    plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table emoticons',
    toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist | link image media table emoticons | forecolor backcolor | preview code',
    menubar: false,
    content_css: false,
    content_style: `
      /* Table Styles with Visible Borders */
      table {
          border-collapse: collapse;
          width: 100%;
          margin: 1rem 0;
          border: 2px solid #000000 !important;
      }
      
      table td, table th {
          border: 1px solid #000000 !important;
          padding: 8px;
          text-align: left;
      }
      
      table th {
          background-color: #f8f9fa;
          fontWeight: bold;
      }
      
      /* Image Styles */
      img {
          max-width: 100%;
          height: auto;
      }
      
      .mce-item-table, .mce-item-table td, .mce-item-table th {
          border: 1px solid #000000 !important;
      }
    `,
    images_upload_handler: function (blobInfo, success, failure) {
      const formData = new FormData();
      formData.append('file', blobInfo.blob(), blobInfo.filename());
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      
      fetch('/upload_image', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || 'Upload failed');
          });
        }
        return response.json();
      })
      .then(data => {
        if (!data.location) throw new Error('Invalid server response');
        success(data.location);
      })
      .catch(error => {
        console.error('Upload error:', error);
        failure(error.message);
      });
    },
    file_picker_callback: function (callback, value, meta) {
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/*');
      input.click();

      input.onchange = function () {
        const file = input.files[0];
        if (!file) return;

        const blobInfo = {
          blob: () => file,
          filename: () => file.name,
          id: () => Date.now().toString()
        };

        tinyMCEConfig.images_upload_handler(
          blobInfo,
          function (url) {
            callback(url, { title: file.name });
          },
          function (error) {
            alert(error);
          }
        );
      };
    },
    automatic_uploads: true,
    images_reuse_filename: true,
    paste_data_images: true,
    image_advtab: true,
    image_caption: true,
    image_title: true,
    setup: function (editor) {
      editor.on('init', function () {
        console.log('Editor initialized for edit form');
      });
    }
  };

  // Track unsaved changes
  let hasUnsavedChanges = false;
  let originalTitle = '';
  let originalContent = '';
  let pendingNavigationUrl = null;
  let unsavedChangesModal = null;
  let cancelConfirmModal = null;

  // Initialize everything when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    tinymce.init({
      selector: '#editor',  // Make sure this matches your textarea ID
      ...tinyMCEConfig
    }).then(function() {
      // Set original values after editor is initialized
      const titleInput = document.querySelector('input[name="title"]');
      if (titleInput) {
        originalTitle = titleInput.value;
      }
      
      if (tinymce.get('editor')) {
        originalContent = tinymce.get('editor').getContent();
      }
      
      // Set up change detection
      setupChangeDetection();
    });
    
    // Initialize the modals
    const unsavedChangesModalElement = document.getElementById('unsavedChangesModal');
    unsavedChangesModal = new bootstrap.Modal(unsavedChangesModalElement);
    
    const cancelConfirmModalElement = document.getElementById('cancelConfirmModal');
    cancelConfirmModal = new bootstrap.Modal(cancelConfirmModalElement);
    
    // Set up cancel button handler
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
      cancelConfirmModal.show();
    });
    
    // Set up modal button handlers for cancel confirmation
    document.getElementById('cancelNoBtn').addEventListener('click', function() {
      cancelConfirmModal.hide();
    });
    
    document.getElementById('cancelYesBtn').addEventListener('click', function() {
      cancelConfirmModal.hide();
      // Redirect back to the content page
      window.location.href = "{{ url_for('view_content', item_name=item_name) }}";
    });
    
    // Override back button behavior
    const backButton = document.getElementById('backButton');
    if (backButton) {
      backButton.addEventListener('click', function(e) {
        if (hasUnsavedChanges) {
          e.preventDefault();
          pendingNavigationUrl = this.href;
          showUnsavedChangesModal();
        }
      });
    }
    
    // Set up modal button handlers
    document.getElementById('stayOnPageBtn').addEventListener('click', function() {
      unsavedChangesModal.hide();
      pendingNavigationUrl = null;
    });
    
    document.getElementById('confirmLeaveBtn').addEventListener('click', function() {
      hasUnsavedChanges = false; // Reset flag to prevent further prompts
      if (pendingNavigationUrl) {
        window.location.href = pendingNavigationUrl;
      }
    });
    
    // Listen for beforeunload event
    window.addEventListener('beforeunload', function(e) {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    // Set up logout link handler after a delay to ensure the navbar is loaded
    setTimeout(setupLogoutHandler, 100);
  });
  
  // Set up logout link handler
  function setupLogoutHandler() {
    // Try to find the logout link in the navbar
    const logoutLink = document.querySelector('a[href*="logout"], .logout-item a, a.nav-link[href*="logout"]');
    
    if (logoutLink) {
      logoutLink.addEventListener('click', function(e) {
        if (hasUnsavedChanges) {
          e.preventDefault();
          pendingNavigationUrl = this.href;
          showUnsavedChangesModal();
        }
      });
      console.log('Logout link handler attached');
    } else {
      console.log('Logout link not found, retrying...');
      // Retry after a short delay if the link wasn't found initially
      setTimeout(setupLogoutHandler, 500);
    }
  }
  
  // Set up change detection for forms
  function setupChangeDetection() {
    // Title input change detection
    const titleInput = document.querySelector('input[name="title"]');
    if (titleInput) {
      titleInput.addEventListener('input', function() {
        checkForChanges();
      });
    }
    
    // TinyMCE change detection
    if (typeof tinymce !== 'undefined' && tinymce.get('editor')) {
      tinymce.get('editor').on('change', function() {
        checkForChanges();
      });
    }
  }
  
  // Check if there are unsaved changes
  function checkForChanges() {
    const titleInput = document.querySelector('input[name="title"]');
    
    let titleChanged = false;
    let contentChanged = false;
    
    if (titleInput && titleInput.value !== originalTitle) {
      titleChanged = true;
    }
    
    if (tinymce.get('editor') && tinymce.get('editor').getContent() !== originalContent) {
      contentChanged = true;
    }
    
    hasUnsavedChanges = titleChanged || contentChanged;
  }
  
  // Show unsaved changes modal
  function showUnsavedChangesModal() {
    if (unsavedChangesModal) {
      unsavedChangesModal.show();
    }
  }
  
  // Reset change tracking after successful save
  function resetChangeTracking() {
    const titleInput = document.querySelector('input[name="title"]');
    if (titleInput) originalTitle = titleInput.value;
    if (tinymce.get('editor')) originalContent = tinymce.get('editor').getContent();
    hasUnsavedChanges = false;
  }

  function saveContent() {
    tinymce.triggerSave();
    
    // Reset change tracking after successful save
    resetChangeTracking();
    
    return true;
  }

  // Function to show alert messages
  function showAlert(message, type) {
    // Remove any existing alerts to prevent clutter
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `custom-alert alert alert-${type} alert-dismissible fade`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Trigger the show animation
    setTimeout(() => alertDiv.classList.add('show'), 10);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        const bsAlert = new bootstrap.Alert(alertDiv);
        bsAlert.close();
      }
    }, 5000);
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>